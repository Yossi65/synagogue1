<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>××—×•×œ×œ ××•×“×¢×•×ª ×©×‘×ª - ×˜×œ ×—×™×™×</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #f0f2f5; color: #333; padding: 20px; max-width: 800px; margin: 0 auto; }
        h1 { text-align: center; color: #2c3e50; }
        .container { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .input-group { margin-bottom: 15px; display: flex; align-items: center; flex-wrap: wrap; }
        .input-group label { flex: 1; min-width: 200px; font-weight: 600; }
        .input-group input[type="text"], 
        .input-group input[type="tel"], 
        .input-group select, 
        .input-group textarea { flex: 1; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 16px; }
        
        /* ×¢×™×¦×•×‘ ××™×•×—×“ ×œ×ª×™×‘×ª ×”×¡×™××•×Ÿ ×©×œ ×”×§×™×“×•×© */
        .checkbox-group { background-color: #fff3cd; padding: 10px; border-radius: 5px; border: 1px solid #ffeeba; }
        .checkbox-group input[type="checkbox"] { width: 20px; height: 20px; margin-left: 10px; cursor: pointer; }
        .checkbox-group label { cursor: pointer; flex: 0 0 auto; margin-left: 10px; }

        .section-title { background-color: #e9ecef; padding: 10px; margin-top: 20px; margin-bottom: 15px; border-radius: 5px; font-weight: bold; color: #495057; border-right: 5px solid #007bff; }
        
        /* ×¢×™×¦×•×‘ ×›×¤×ª×•×¨×™× */
        .buttons-container { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        button.action-btn { flex: 1; padding: 15px; border: none; border-radius: 5px; font-size: 16px; font-weight:bold; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; color: white; min-width: 150px; }
        button.action-btn:active { transform: scale(0.98); }
        
        .btn-whatsapp-text { background-color: #28a745; } /* ×™×¨×•×§ ×¨×’×™×œ */
        .btn-share-all { background-color: #128C7E; border: 2px solid #075E54; } /* ×™×¨×•×§ ×•×•×¦××¤ ×¨×©××™ ×›×”×” */
        .btn-print { background-color: #fd7e14; }
        .btn-image { background-color: #000000; }
        .btn-download { background-color: #007bff; width: 100%; margin-top: 10px; }
        
        .template-actions { background-color: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 20px; display: flex; gap: 10px; justify-content: center; }
        .btn-save-template { background-color: #17a2b8; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; flex: 1; }
        .btn-clear { background-color: #6c757d; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; flex: 0.3; }
        
        #generated-image-container { margin-top: 30px; text-align: center; display: none; }
        #generated-image-container img { max-width: 100%; height: auto; border-radius: 8px; border: 3px solid #5c3a21; }
        #hiddenCanvas { display: none; }
        #imageStatus { font-weight: bold; margin-bottom: 10px; color: #0056b3; }
        
        #text-output-area { display: none; margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; }
        #output-title { margin-top: 0; }
        
        textarea#text-result { width: 100%; height: 200px; font-family: monospace; display:block; }
        
        #print-result { 
            background: white; 
            padding: 20px; 
            border: 1px solid #ccc; 
            min-height: 200px; 
            text-align: center; 
            font-family: 'David', 'Arial', sans-serif;
            font-size: 18px;
            white-space: pre-wrap;
            direction: rtl;
            display: none;
        }

        .copy-btn { background-color: #007bff; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; width: 100%; }
        
        .slider-container { background-color: #fff3cd; padding: 10px; border-radius: 8px; text-align: center; margin-bottom: 20px;}
        input[type=range] { width: 80%; }
        
        /* ×¡×™××Ÿ ×§×˜×Ÿ ×œ×©××™×¨×” ××•×˜×•××˜×™×ª */
        .auto-save-indicator { text-align: center; font-size: 12px; color: #888; margin-top: -10px; margin-bottom: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h1>××—×•×œ×œ ××•×“×¢×•×ª ×©×‘×ª - ×˜×œ ×—×™×™×</h1>
    <div class="auto-save-indicator">âœ¨ ×›×œ ×©×™× ×•×™ × ×©××¨ ××•×˜×•××˜×™×ª</div>
    
    <div style="text-align:center; margin-bottom: 20px; padding: 10px; background: #e3f2fd; border-radius: 8px;">
        <p id="imageStatus">×˜×•×¢×Ÿ ×ª××•× ×ª ×¨×§×¢ ××”×¢× ×Ÿ...</p>
        <input type="file" id="bgImageInput" accept="image/png, image/jpeg" style="display:none; margin-top:5px;"> 
        <button onclick="document.getElementById('bgImageInput').style.display='inline-block'" style="background:none; border:none; text-decoration:underline; color:#666; font-size:12px; cursor:pointer;">(×”×¢×œ××” ×™×“× ×™×ª ×‘××§×¨×” ×©×œ ×ª×§×œ×”)</button>
    </div>

    <div class="slider-container">
        <label>×’×•×“×œ ×˜×§×¡×˜ ×‘×ª××•× ×”:</label><br>
        <input type="range" id="fontSizeSlider" min="20" max="50" value="32">
    </div>

    <div class="template-actions">
        <button class="btn-save-template" onclick="saveFormData(false)">ğŸ’¾ ×©××™×¨×” ×™×“× ×™×ª (×œ× ×—×•×‘×”)</button>
        <button class="btn-clear" onclick="clearFormData()">ğŸ—‘ï¸ × ×§×” ×”×›×œ</button>
    </div>

    <div class="input-group">
        <label>×‘×—×¨ ×¤×¨×©×”:</label>
        <select id="parasha">
            <option value="" selected>×œ×œ× / ×™×“× ×™</option>
            <optgroup label="×‘×¨××©×™×ª"><option>×‘×¨××©×™×ª</option><option>× ×—</option><option>×œ×š ×œ×š</option><option>×•×™×¨×</option><option>×—×™×™ ×©×¨×”</option><option>×ª×•×œ×“×•×ª</option><option>×•×™×¦×</option><option>×•×™×©×œ×—</option><option>×•×™×©×‘</option><option>××§×¥</option><option>×•×™×’×©</option><option>×•×™×—×™</option></optgroup>
            <optgroup label="×©××•×ª"><option>×©××•×ª</option><option>×•××¨×</option><option>×‘×</option><option>×‘×©×œ×—</option><option>×™×ª×¨×•</option><option>××©×¤×˜×™×</option><option>×ª×¨×•××”</option><option>×ª×¦×•×”</option><option>×›×™ ×ª×©×</option><option>×•×™×§×”×œ</option><option>×¤×§×•×“×™</option></optgroup>
            <optgroup label="×•×™×§×¨×"><option>×•×™×§×¨×</option><option>×¦×•</option><option>×©××™× ×™</option><option>×ª×–×¨×™×¢</option><option>××¦×•×¨×¢</option><option>××—×¨×™ ××•×ª</option><option>×§×“×•×©×™×</option><option>×××•×¨</option><option>×‘×”×¨</option><option>×‘×—×•×§×•×ª×™</option></optgroup>
            <optgroup label="×‘××“×‘×¨"><option>×‘××“×‘×¨</option><option>× ×©×</option><option>×‘×”×¢×œ×•×ª×š</option><option>×©×œ×—</option><option>×§×•×¨×—</option><option>×—×•×§×ª</option><option>×‘×œ×§</option><option>×¤× ×—×¡</option><option>××˜×•×ª</option><option>××¡×¢×™</option></optgroup>
            <optgroup label="×“×‘×¨×™×"><option>×“×‘×¨×™×</option><option>×•××ª×—× ×Ÿ</option><option>×¢×§×‘</option><option>×¨××”</option><option>×©×•×¤×˜×™×</option><option>×›×™ ×ª×¦×</option><option>×›×™ ×ª×‘×•×</option><option>× ×¦×‘×™×</option><option>×•×™×œ×š</option><option>×”××–×™× ×•</option><option>×•×–××ª ×”×‘×¨×›×”</option></optgroup>
            <optgroup label="×—×’×™×"><option>×¨××© ×”×©× ×”</option><option>×™×•× ×›×™×¤×•×¨</option><option>×¡×•×›×•×ª</option><option>×©××—×ª ×ª×•×¨×”</option><option>×—× ×•×›×”</option><option>×¤×•×¨×™×</option><option>×¤×¡×—</option><option>×©×‘×•×¢×•×ª</option><option>×™×•× ×”×¢×¦×××•×ª</option></optgroup>
        </select>
    </div>
    <div class="input-group"><label>××• ×”×§×œ×“ ×™×“× ×™×ª:</label><input type="text" id="custom_parasha"></div>

    <div class="section-title">×–×× ×™×</div>
    <div class="input-group"><label>×›× ×™×¡×ª ×”×©×‘×ª:</label><input type="tel" id="time_knisa" class="time-input"></div>
    <div class="input-group"><label>×¦××ª ×”×©×‘×ª:</label><input type="tel" id="time_tzeit" class="time-input"></div>
    
    <div class="section-title">×¢×¨×‘ ×©×‘×ª</div>
    <div class="input-group"><label>×× ×—×” ×¢×¨×‘ ×©×‘×ª:</label><input type="tel" id="time_mincha_eve" class="time-input"></div>
    <div class="input-group"><label>×§×‘×œ×ª ×©×‘×ª ×•×¢×¨×‘×™×ª:</label><input type="tel" id="time_kabalat" class="time-input"></div>
    <div class="input-group"><label>×”×•×“×¢×” ××™×•×—×“×ª:</label><textarea id="special_eve" style="height:50px"></textarea></div>

    <div class="section-title">×‘×•×§×¨ ×©×‘×ª</div>
    <div class="input-group"><label>×©×—×¨×™×ª (×§×•×¨×‘× ×•×ª):</label><input type="tel" id="time_shacharit" class="time-input"></div>
    <div class="input-group"><label>×”×•×“×•:</label><input type="tel" id="time_hodu" class="time-input"></div>
    <div class="input-group"><label>×ª×¤×™×œ×ª ×™×œ×“×™×:</label><input type="text" id="text_kids" value="×ª×¤×™×œ×ª ×™×œ×“×™× ×œ××—×¨ ××•×¡×£."></div>
    <div class="input-group"><label>×”×•×“×¢×” ××™×•×—×“×ª:</label><textarea id="special_morning" style="height:50px"></textarea></div>
    
    <div class="input-group checkbox-group">
        <input type="checkbox" id="chk_kiddush">
        <label for="chk_kiddush">×”×•×¡×£ ×§×™×“×•×© ×œ××•×“×¢×”</label>
        <input type="text" id="text_kiddush" value="×§×™×“×•×© ×§×”×™×œ×ª×™ ×œ××—×¨ ×”×ª×¤×™×œ×”">
    </div>

    <div class="section-title">×¦×”×¨×™×™×</div>
    <div class="input-group"><label>×ª×”×™×œ×™× ×œ×™×œ×“×™×:</label><input type="tel" id="time_psalms" class="time-input"></div>
    <div class="input-group"><label>×©×™×¢×•×¨ ×œ×¤× ×™ ×× ×—×”:</label><input type="tel" id="time_class_mincha" class="time-input"></div>
    <div class="input-group"><label>×× ×—×” ×©×œ ×©×‘×ª:</label><input type="tel" id="time_mincha_day" class="time-input"></div>
    <div class="input-group"><label>×©×™×¢×•×¨ ×œ× ×©×™×:</label><input type="tel" id="time_women" class="time-input"></div>
    <div class="input-group"><label>×©×™×¢×•×¨ ×œ×¤× ×™ ×¢×¨×‘×™×ª:</label><input type="tel" id="time_class_arvit" class="time-input"></div>
    <div class="input-group"><label>×¢×¨×‘×™×ª ××•×¦"×©:</label><input type="tel" id="time_arvit_motzash" class="time-input"></div>

    <div class="section-title">×™××•×ª ×”×©×‘×•×¢</div>
    <div class="input-group"><label>×©×—×¨×™×ª (×©×™×©×™):</label><input type="tel" id="time_week_shacharit" value="08:15" class="time-input"></div>
    <div class="input-group"><label>×¢×¨×‘×™×ª (×—×•×œ):</label><input type="tel" id="time_week_arvit" value="20:15" class="time-input"></div>

    <div class="buttons-container">
        <button class="action-btn btn-share-all" onclick="shareToWhatsapp()">ğŸš€ ×©×œ×™×—×” ×œ×•×•×¦××¤ (×ª××•× ×” + ×˜×§×¡×˜)</button>
        
        <button class="action-btn btn-whatsapp-text" onclick="generateText('whatsapp')">×”×›×Ÿ ×˜×§×¡×˜ ×œ×•×•××˜×¡××¤</button>
        <button class="action-btn btn-print" onclick="generateText('print')">×˜×§×¡×˜ ×œ×”×“×¤×¡×”</button>
        <button class="action-btn btn-image" onclick="generateImage()">×¦×•×¨ ×ª××•× ×” ×œ×”×•×¨×“×”</button>
    </div>

    <div id="text-output-area">
        <h3 id="output-title">×”×•×“×¢×” ××•×›× ×”:</h3>
        <textarea id="text-result"></textarea>
        <div id="print-result" contenteditable="true"></div>
        <button class="copy-btn" onclick="copyToClipboard()">ğŸ“‹ ×”×¢×ª×§ ×œ×œ×•×—</button>
    </div>

    <div id="generated-image-container">
        <h3>×”×ª××•× ×” ×”××•×›× ×”:</h3>
        <img id="finalImage">
        <button class="action-btn btn-download" onclick="downloadImage()">ğŸ“¥ ×”×•×¨×“ ×ª××•× ×” ×œ××›×©×™×¨</button>
    </div>
</div>

<canvas id="hiddenCanvas"></canvas>

<script>
    let loadedBgImage = null;
    let currentMode = 'whatsapp'; 
    const canvas = document.getElementById('hiddenCanvas');
    const ctx = canvas.getContext('2d');
    const imageStatus = document.getElementById('imageStatus');

    window.onload = function() {
        const img = new Image();
        img.src = 'https://raw.githubusercontent.com/Yossi65/synagogue/main/background.png'; 
        img.crossOrigin = "Anonymous"; 
        
        img.onload = function() {
            loadedBgImage = img;
            canvas.width = img.width;
            canvas.height = img.height;
            imageStatus.innerText = "âœ… ×ª××•× ×ª ×¨×§×¢ × ×˜×¢× ×” ×‘×”×¦×œ×—×” ××”×¢× ×Ÿ!";
            imageStatus.style.color = "green";
            document.getElementById('bgImageInput').style.display = 'none';
        };

        img.onerror = function() {
            imageStatus.innerText = "âš ï¸ ×©×’×™××” ×‘×˜×¢×™× ×”. × ×¡×” ×œ×¨×¢× ×Ÿ ××• ×œ×”×¢×œ×•×ª ×™×“× ×™×ª.";
            imageStatus.style.color = "red";
        };

        const savedData = localStorage.getItem('shabbatFormData');
        if (savedData) {
            const data = JSON.parse(savedData);
            for (const key in data) {
                const el = document.getElementById(key);
                if (el) {
                    if(el.type === 'checkbox') {
                        el.checked = data[key];
                    } else {
                        el.value = data[key];
                    }
                }
            }
        }
        
        // ×”×¤×¢×œ×ª ××¢×¨×›×ª ×”×©××™×¨×” ×”××•×˜×•××˜×™×ª ×‘×˜×¢×™× ×”
        setupAutoSave();
    };
    
    // ×¤×•× ×§×¦×™×” ×—×“×©×” ×©××¦××™×“×” ××™×¨×•×¢×™ ×©××™×¨×” ×œ×›×œ ×©×“×” ××¤×©×¨×™
    function setupAutoSave() {
        // ×‘×•×—×¨ ××ª ×›×œ ×¡×•×’×™ ×”×§×œ×˜: ×˜×§×¡×˜, ××¡×¤×¨, ×ª×™×‘×•×ª ×¡×™××•×Ÿ, ×¨×©×™××•×ª × ×¤×ª×—×•×ª ×•×›×•'
        const inputs = document.querySelectorAll('input, textarea, select');
        
        inputs.forEach(input => {
            // ××™×¨×•×¢ 'input' ×ª×•×¤×¡ ×›×œ ×”×§×œ×“×” ×‘×–××Ÿ ×××ª
            input.addEventListener('input', () => saveFormData(true));
            // ××™×¨×•×¢ 'change' ×ª×•×¤×¡ ×©×™× ×•×™×™× ×›××• ×‘×—×™×¨×” ×‘×¨×©×™××” ××• ×¦'×§×‘×•×§×¡
            input.addEventListener('change', () => saveFormData(true));
        });
    }

    document.getElementById('bgImageInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(event) {
            const img = new Image();
            img.onload = function() {
                loadedBgImage = img;
                canvas.width = img.width;
                canvas.height = img.height;
                imageStatus.innerText = "âœ… ×ª××•× ×” ×”×•×¢×œ×ª×” ×™×“× ×™×ª";
                imageStatus.style.color = "green";
            }
            img.src = event.target.result;
        }
        reader.readAsDataURL(file);
    });

    document.querySelectorAll('.time-input').forEach(input => {
        input.addEventListener('blur', function() {
            let val = this.value.replace(/[^0-9]/g, '');
            if (val.length === 0) return;
            if (val.length === 1) val = "0" + val + ":00";
            else if (val.length === 2) val = val + ":00";
            else if (val.length === 3) val = "0" + val.substring(0,1) + ":" + val.substring(1);
            else if (val.length >= 4) val = val.substring(0, 2) + ":" + val.substring(2, 4);
            this.value = val;
            saveFormData(true); // ×©××™×¨×” ×’× ××—×¨×™ ×¤×™×¨××•×˜ ×”×©×¢×”
        });
    });

    function saveFormData(silent = false) {
        const data = {};
        // ×©××™×¨×ª ×›×œ ×”×©×“×•×ª
        document.querySelectorAll('input[type="text"], input[type="tel"], textarea, select').forEach(input => {
            if(input.id !== 'fontSizeSlider') data[input.id] = input.value;
        });
        
        // ×©××™×¨×” ××™×•×—×“×ª ×œ×¦'×§×‘×•×§×¡
        const chk = document.getElementById('chk_kiddush');
        if(chk) data['chk_kiddush'] = chk.checked;

        localStorage.setItem('shabbatFormData', JSON.stringify(data));
        
        if (!silent) {
            alert('×”× ×ª×•× ×™× × ×©××¨×• ×‘×”×¦×œ×—×”!');
        }
    }

    function clearFormData() {
        if(confirm("×œ× ×§×•×ª ×”×›×œ?")) {
            document.querySelectorAll('input[type="text"], input[type="tel"], textarea').forEach(i => i.value = '');
            document.getElementById('parasha').value = '';
            document.getElementById('chk_kiddush').checked = false;
            saveFormData(true); // ×©××™×¨×” ×©×œ ×”× ×™×§×•×™
        }
    }

    function getFormData() {
        const listParasha = document.getElementById('parasha').value;
        const customParasha = document.getElementById('custom_parasha').value;
        let finalParashaName = customParasha.trim() !== "" ? customParasha : listParasha;
        
        const data = { parasha: finalParashaName };
        const ids = ['time_knisa', 'time_tzeit', 'time_mincha_eve', 'time_kabalat', 'special_eve', 
                     'time_shacharit', 'time_hodu', 'text_kids', 'special_morning', 'time_psalms', 
                     'time_class_mincha', 'time_mincha_day', 'time_women', 'time_class_arvit', 
                     'time_arvit_motzash', 'time_week_shacharit', 'time_week_arvit', 'text_kiddush'];
        ids.forEach(id => data[id] = document.getElementById(id).value);
        
        // ×”×•×¡×¤×ª ×¡×˜×˜×•×¡ ×”×§×™×“×•×©
        data.hasKiddush = document.getElementById('chk_kiddush').checked;

        return data;
    }

    async function shareToWhatsapp() {
        saveFormData(true); // ×©××™×¨×” ×©×§×˜×” ××•×˜×•××˜×™×ª ×œ×¤× ×™ ×‘×™×¦×•×¢ ×¤×¢×•×œ×”

        if (!loadedBgImage) { alert("××™×Ÿ ×ª××•× ×ª ×¨×§×¢!"); return; }
        
        // 1. ××™×™×¦×¨×™× ×ª××•× ×” (×‘×¨×§×¢)
        generateImage(true); 

        // 2. ××›×™× ×™× ×˜×§×¡×˜
        const whatsappText = buildTextString(true);

        // 3. ×™×•×¦×¨×™× ×§×•×‘×¥ ×•×©×•×œ×—×™×
        canvas.toBlob(async (blob) => {
            if (!blob) return;
            const file = new File([blob], "shabbat_times.jpg", { type: "image/jpeg" });
            
            try {
                const tempInput = document.createElement("textarea");
                tempInput.value = whatsappText;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand("copy");
                document.body.removeChild(tempInput);
                
                alert("×”×˜×§×¡×˜ ×”×•×¢×ª×§ ×œ×–×™×›×¨×•×Ÿ!\n\n×× ×”×•× ×œ× ××•×¤×™×¢ ××•×˜×•××˜×™×ª ××ª×—×ª ×œ×ª××•× ×” - ×¢×©×” '×”×“×‘×§' (Paste).");
            } catch (err) {
                console.log("Copy failed", err);
            }

            if (navigator.share && navigator.canShare && navigator.canShare({ files: [file] })) {
                try {
                    await navigator.share({
                        files: [file],
                        text: whatsappText, 
                        title: '×–×× ×™ ×©×‘×ª - ×˜×œ ×—×™×™×'
                    });
                } catch (error) {
                    console.log('Share error:', error);
                }
            } else {
                alert("×”×“×¤×“×¤×Ÿ ×”×–×” ×œ× ×ª×•××š ×‘×©×™×ª×•×£ ×ª××•× ×” ×™×©×™×¨.\n×™×© ×œ×”×•×¨×™×“ ××ª ×”×ª××•× ×” ×•×œ×”×¢×ª×™×§ ××ª ×”×˜×§×¡×˜.");
                generateText('whatsapp');
            }
        }, 'image/jpeg', 0.9);
    }

    function buildTextString(isWhatsapp) {
        const data = getFormData();
        const fmt = (text) => (isWhatsapp && text) ? `*${text}*` : (text || '');
        
        let msg = `${fmt("×–×× ×™ ×ª×¤×™×œ×•×ª ×‘×™×”×›× \"×¡ ×˜×œ-×—×™×™× - ×¤×¨×©×ª " + data.parasha)}\n\n`;
        
        let timesLine = "";
        if(data.time_knisa) timesLine += `×›× ×™×¡×ª ×”×©×‘×ª: ${data.time_knisa}`;
        if(data.time_knisa && data.time_tzeit) timesLine += `  |  `;
        if(data.time_tzeit) timesLine += `×¦××ª ×”×©×‘×ª: ${data.time_tzeit}`;
        
        if(timesLine) msg += `${fmt(timesLine)}\n\n`;

        if(data.time_mincha_eve) msg += `×× ×—×” ×¢×¨×‘ ×©×‘×ª (××©×¨×™) - ${fmt(data.time_mincha_eve)}\n`;
        if(data.time_kabalat) msg += `×§×‘×œ×ª ×©×‘×ª ×•×¢×¨×‘×™×ª - ${fmt(data.time_kabalat)}\n`;
        if(data.special_eve) msg += `${fmt(data.special_eve)}\n`;
        
        msg += `\n`;
        if(data.time_shacharit) msg += `×©×—×¨×™×ª (×§×•×¨×‘× ×•×ª) - ${fmt(data.time_shacharit)}\n`;
        if(data.time_hodu) msg += `×”×•×“×• - ${fmt(data.time_hodu)}\n`;
        if(data.text_kids) msg += `${data.text_kids}\n`;
        if(data.special_morning) msg += `${fmt(data.special_morning)}\n`;
        
        // ×”×•×¡×¤×ª ×”×§×™×“×•×© ×× ×¡×•××Ÿ
        if(data.hasKiddush && data.text_kiddush) {
             msg += `${fmt(data.text_kiddush)}\n`;
        }

        msg += `\n`;
        if(data.time_psalms) msg += `×ª×”×™×œ×™× ×œ×™×œ×“×™× - ${fmt(data.time_psalms)}\n`;
        if(data.time_class_mincha) msg += `×©×™×¢×•×¨ ×œ×¤× ×™ ×× ×—×” - ${fmt(data.time_class_mincha)}\n`;
        if(data.time_mincha_day) msg += `×× ×—×” ×©×œ ×©×‘×ª - ${fmt(data.time_mincha_day)}\n`;
        if(data.time_women) msg += `×©×™×¢×•×¨ ×œ× ×©×™× - ${fmt(data.time_women)}\n`;
        if(data.time_class_arvit) msg += `×©×™×¢×•×¨ ×œ×¤× ×™ ×¢×¨×‘×™×ª - ${fmt(data.time_class_arvit)}\n`;
        if(data.time_arvit_motzash) msg += `×¢×¨×‘×™×ª ××•×¦"×© - ${fmt(data.time_arvit_motzash)}\n`;

        msg += `\n${fmt("×ª×¤×™×œ×•×ª ×‘×©××¨ ×™××•×ª ×”×©×‘×•×¢:")}\n`;
        msg += `×©×—×¨×™×ª (×©×™×©×™) - ${fmt(data.time_week_shacharit)}, ×¢×¨×‘×™×ª - ${fmt(data.time_week_arvit)}\n`;
        
        msg += `\n${fmt("×©×‘×ª ×©×œ×•×")}\n`;
        return msg;
    }

    function generateText(mode) {
        saveFormData(true); // ×©××™×¨×” ×©×§×˜×” ××•×˜×•××˜×™×ª

        currentMode = mode;
        const msg = buildTextString(mode === 'whatsapp');

        const textarea = document.getElementById('text-result');
        const printDiv = document.getElementById('print-result');
        const title = document.getElementById('output-title');

        if (mode === 'whatsapp') {
            title.innerText = "×”×•×“×¢×” ×œ×•×•××˜×¡××¤:";
            textarea.style.display = 'block';
            printDiv.style.display = 'none';
            textarea.value = msg;
        } else {
            title.innerText = "×˜×§×¡×˜ ×œ×”×“×¤×¡×” (×”×¢×ª×§ ×•×”×“×‘×§ ×œ×•×•×¨×“):";
            textarea.style.display = 'none';
            printDiv.style.display = 'block';
            printDiv.innerText = msg; 
        }

        document.getElementById('text-output-area').style.display = 'block';
        document.getElementById('generated-image-container').style.display = 'none';
        document.getElementById('text-output-area').scrollIntoView({behavior: "smooth"});
    }

    function copyToClipboard() {
        if (currentMode === 'print') {
             const range = document.createRange();
             range.selectNode(document.getElementById("print-result"));
             window.getSelection().removeAllRanges();
             window.getSelection().addRange(range);
             document.execCommand("copy");
             window.getSelection().removeAllRanges();
             alert("×”×˜×§×¡×˜ ×”×•×¢×ª×§! ×”×“×‘×§ ×‘×•×•×¨×“.");
        } else {
            const txt = document.getElementById("text-result");
            txt.select();
            document.execCommand('copy');
            alert("×”×•×¢×ª×§!");
        }
    }

    function generateImage(silentMode = false) {
        if(!silentMode) saveFormData(true); // ×©××™×¨×” ×©×§×˜×” ××•×˜×•××˜×™×ª, ××œ× ×× ×”×¤×•× ×§×¦×™×” × ×§×¨××” ××ª×•×š ×”×©×™×ª×•×£ ×©×›×‘×¨ ×©××¨

        if (!loadedBgImage) { if(!silentMode) alert("××™×Ÿ ×ª××•× ×ª ×¨×§×¢!"); return; }
        const data = getFormData();
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.drawImage(loadedBgImage, 0, 0);
        
        ctx.textAlign = 'center'; 
        ctx.fillStyle = '#000000'; 
        const centerX = canvas.width / 2;
        const fontMultiplier = document.getElementById('fontSizeSlider').value / 1000;
        const fontSize = canvas.height * fontMultiplier;
        const lineHeight = fontSize * 1.3; 

        // 1. ×©× ×”×¤×¨×©×”
        let headerY = canvas.height * 0.17; 
        ctx.font = 'bold ' + (fontSize * 1.3) + 'px "David", "Frank Ruhl Libre", serif';
        ctx.fillText(`×¤×¨×©×ª ${data.parasha}`, centerX, headerY);

        // 2. ×›× ×™×¡×ª/×¦××ª ×©×‘×ª
        let currentY = canvas.height * 0.26; 
        ctx.font = 'bold ' + (fontSize * 0.85) + 'px "David", "Frank Ruhl Libre", serif';

        let timesStr = "";
        if(data.time_knisa) timesStr += `×›× ×™×¡×ª ×”×©×‘×ª: ${data.time_knisa}`;
        if(data.time_knisa && data.time_tzeit) timesStr += `  |  `;
        if(data.time_tzeit) timesStr += `×¦××ª ×”×©×‘×ª: ${data.time_tzeit}`;
        
        if (timesStr) {
            ctx.fillText(timesStr, centerX, currentY);
            currentY += lineHeight * 1.2; 
        }

        // 3. ×¨×©×™××ª ×”×ª×¤×™×œ×•×ª
        ctx.font = 'bold ' + fontSize + 'px "David", "Frank Ruhl Libre", serif';

        function draw(txt) {
            if (currentY > canvas.height * 0.82) return; 
            if (txt && txt.trim()) { 
                ctx.fillText(txt, centerX, currentY); 
                currentY += lineHeight; 
            }
        }

        draw(data.time_mincha_eve ? `×× ×—×” ×¢×¨×‘ ×©×‘×ª (××©×¨×™) - ${data.time_mincha_eve}` : '');
        draw(data.time_kabalat ? `×§×‘×œ×ª ×©×‘×ª ×•×¢×¨×‘×™×ª - ${data.time_kabalat}` : '');
        
        if(data.special_eve) {
             currentY += lineHeight * 0.2;
             draw(data.special_eve);
             currentY += lineHeight * 0.2;
        }

        if (currentY < canvas.height * 0.7) currentY += lineHeight * 0.3;
        
        draw(data.time_shacharit ? `×©×—×¨×™×ª (×§×•×¨×‘× ×•×ª) - ${data.time_shacharit}` : '');
        draw(data.time_hodu ? `×”×•×“×• - ${data.time_hodu}` : '');
        draw(data.text_kids);
        if(data.special_morning) {
             currentY += lineHeight * 0.2;
             draw(data.special_morning);
             currentY += lineHeight * 0.2;
        }

        // ×¦×™×•×¨ ×”×§×™×“×•×© ×× ××¡×•××Ÿ
        if(data.hasKiddush && data.text_kiddush) {
            currentY += lineHeight * 0.1;
            draw(data.text_kiddush);
            currentY += lineHeight * 0.1;
        }

        if (currentY < canvas.height * 0.7) currentY += lineHeight * 0.3;

        draw(data.time_psalms ? `×ª×”×™×œ×™× ×œ×™×œ×“×™× - ${data.time_psalms}` : '');
        draw(data.time_class_mincha ? `×©×™×¢×•×¨ ×œ×¤× ×™ ×× ×—×” - ${data.time_class_mincha}` : '');
        draw(data.time_mincha_day ? `×× ×—×” ×©×œ ×©×‘×ª - ${data.time_mincha_day}` : '');
        draw(data.time_women ? `×©×™×¢×•×¨ ×œ× ×©×™× - ${data.time_women}` : '');
        draw(data.time_class_arvit ? `×©×™×¢×•×¨ ×œ×¤× ×™ ×¢×¨×‘×™×ª - ${data.time_class_arvit}` : '');
        draw(data.time_arvit_motzash ? `×¢×¨×‘×™×ª ××•×¦"×© - ${data.time_arvit_motzash}` : '');

        // 4. ×ª×¤×™×œ×•×ª ×—×•×œ
        let bottomY = canvas.height * 0.835; 
        ctx.font = 'bold ' + (fontSize * 0.85) + 'px "David", "Frank Ruhl Libre", serif';
        
        ctx.fillText("×ª×¤×™×œ×•×ª ×‘×©××¨ ×™××•×ª ×”×©×‘×•×¢:", centerX, bottomY);
        bottomY += lineHeight;
        
        let weekTimes = "";
        if(data.time_week_shacharit) weekTimes += `×©×—×¨×™×ª (×©×™×©×™) - ${data.time_week_shacharit}`;
        if(data.time_week_shacharit && data.time_week_arvit) weekTimes += `, `;
        if(data.time_week_arvit) weekTimes += `×¢×¨×‘×™×ª - ${data.time_week_arvit}`;
        ctx.fillText(weekTimes, centerX, bottomY);

        // 5. ×©×‘×ª ×©×œ×•×
        ctx.font = 'bold ' + (fontSize * 1.3) + 'px serif';
        ctx.fillText("×©×‘×ª ×©×œ×•×", centerX, canvas.height * 0.915); 


        document.getElementById('finalImage').src = canvas.toDataURL('image/jpeg', 0.9);
        if (!silentMode) {
            document.getElementById('generated-image-container').style.display = 'block';
            document.getElementById('text-output-area').style.display = 'none';
            document.getElementById('generated-image-container').scrollIntoView({behavior: "smooth"});
        }
    }

    function downloadImage() {
        saveFormData(true); // ×©××™×¨×” ×©×§×˜×” ×’× ×‘×”×•×¨×“×”
        const link = document.createElement('a');
        const data = getFormData();
        const fileName = `×–×× ×™_×©×‘×ª_×¤×¨×©×ª_${data.parasha.replace(/\s+/g, '_')}.jpg`;
        
        link.download = fileName;
        link.href = document.getElementById('finalImage').src;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
    }
</script>
</body>
</html>
